<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ø±Ø³</title> <!-- Buzzer Game Control Panel -->
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Add specific styles for admin page if needed */
        body { background-color: #f8f9fa; } /* Light grey background */
        .container { border: 2px solid #007bff; } /* Primary Blue border */
        #admin-title { color: #007bff; } /* Primary Blue title */
    </style>
</head>
<body>
    <div class="container">
        <h1 id="admin-title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1> <!-- Control Panel -->
        <div id="buzzer-status">
            <p id="status-message">â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§ØªØµØ§Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</p> <!-- Waiting for players to connect... -->
            <ol id="ranking-list" style="display: none;"></ol> <!-- Ordered list for rankings -->
        </div>
        <button id="reset-button" style="display: none;">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ø±Ø³</button> <!-- Reset Buzzer -->
        <p id="connection-status" style="margin-top: 20px; color: grey;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</p> <!-- Connecting... -->
    </div>

    <script>
        const resetButton = document.getElementById('reset-button');
        const statusMessage = document.getElementById('status-message');
        const rankingList = document.getElementById('ranking-list');
        const connectionStatus = document.getElementById('connection-status');
        let ws = null;

        function connectWebSocket() {
            connectionStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // Connect with role=admin query parameter
            const wsUrl = `${wsProtocol}//${window.location.host}/ws?role=admin`;
            ws = new WebSocket(wsUrl);

            ws.onopen = function(event) {
                console.log("Admin WebSocket connection established");
                connectionStatus.textContent = 'âœ… Ù…ØªØµÙ„'; // Connected
                connectionStatus.style.color = 'green';
            };

            ws.onmessage = function(event) {
                console.log("Admin received message: ", event.data);
                try {
                    // Admin uses the same state message structure
                    const state = JSON.parse(event.data);
                    updateUI(state);
                } catch (e) {
                    console.error("Admin failed to parse message:", e);
                    statusMessage.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©!';
                }
            };

            ws.onerror = function(event) {
                console.error("Admin WebSocket error:", event);
                statusMessage.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„!';
                connectionStatus.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
                connectionStatus.style.color = 'red';
            };

            ws.onclose = function(event) {
                console.log("Admin WebSocket closed. Reconnecting...");
                statusMessage.textContent = 'Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„!';
                connectionStatus.textContent = 'ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...';
                connectionStatus.style.color = 'orange';
                ws = null; // Ensure ws is null so button clicks fail until reconnected
                setTimeout(connectWebSocket, 5000);
            };
        }

        resetButton.onclick = function() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log("Admin sending reset action");
                ws.send(JSON.stringify({ action: 'reset' }));
            } else {
                console.error("Admin WebSocket is not connected.");
                statusMessage.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…!';
            }
        };

        function updateUI(state) {
            rankingList.innerHTML = ''; // Clear previous list

            // Use the new buzz_details field which includes names and deltas
            if (state.buzz_details && state.buzz_details.length > 0) {
                statusMessage.style.display = 'none';
                rankingList.style.display = 'block';

                state.buzz_details.forEach((detail, index) => {
                    const rank = index + 1;
                    const listItem = document.createElement('li');
                    let suffix = " ";
                    if (rank === 1) suffix = "ğŸ¥‡";
                    else if (rank === 2) suffix = "ğŸ¥ˆ";
                    else if (rank === 3) suffix = "ğŸ¥‰";

                    let timeDiffText = "";
                    // Display delta time for players after the first one
                    if (detail.delta !== null && detail.delta !== undefined) {
                        // Format to 2 decimal places and add 's' for seconds
                        timeDiffText = ` (+${detail.delta.toFixed(2)} Ø«)`; // "s" for seconds in Arabic
                    }

                    listItem.textContent = `${detail.name}${suffix}${timeDiffText}`;
                    rankingList.appendChild(listItem);
                });

                resetButton.style.display = 'inline-block'; // Show reset button if there are buzzes
            } else {
                // No one has buzzed yet (reset state)
                statusMessage.textContent = 'ğŸ”” Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø£ÙˆÙ„ Ø¶ØºØ·Ø© Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†! ğŸ””'; // Waiting for first player buzz!
                statusMessage.style.display = 'block';
                rankingList.style.display = 'none';
                resetButton.style.display = 'none'; // Hide reset button if no one buzzed
            }
            // Reset button visibility is now correctly handled based on buzz_details length.
        }

        // Initial connection attempt
        connectWebSocket();
    </script>
</body>
</html>